<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unitage Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
</head>
<body class="bg-stone-50 font-sans text-stone-900">

    <div id="login-screen" class="flex h-screen items-center justify-center">
        <form onsubmit="event.preventDefault(); login()" class="bg-white p-8 rounded-lg shadow-lg w-96">
            <h2 class="text-2xl font-bold mb-6 text-center">–í—Ö–æ–¥ –≤ Unitage</h2>
            <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" class="w-full p-3 border border-stone-300 rounded mb-4 focus:outline-none focus:border-red-800" autofocus>
            <button type="submit" class="w-full bg-red-800 text-white py-3 rounded font-semibold hover:bg-red-900 transition">–í–æ–π—Ç–∏</button>
            <p class="mt-4 text-xs text-center text-stone-400">–ü–∞—Ä–æ–ª—å: admin123</p>
        </form>
    </div>

    <div id="admin-panel" class="hidden min-h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-stone-900 text-stone-300 fixed h-full flex flex-col">
            <div class="p-6 text-white font-bold text-xl border-b border-stone-800">Unitage OS</div>
            <nav class="flex-1 p-4 space-y-2">
                <a href="#" class="block px-4 py-2 bg-stone-800 text-white rounded">üìù –ù–æ–≤–∞—è —Å—Ç–∞—Ç—å—è</a>
                <a href="#" class="block px-4 py-2 hover:bg-stone-800 rounded">üìö –í—Å–µ —Å—Ç–∞—Ç—å–∏</a>
                <a href="#" class="block px-4 py-2 hover:bg-stone-800 rounded">ü§ñ AI –ê–≥–µ–Ω—Ç—ã</a>
            </nav>
            <div class="p-4 border-t border-stone-800 text-xs text-stone-500">
                v2.0 Beta
            </div>
        </aside>

        <!-- Main Content -->
        <main class="ml-64 p-12 max-w-5xl">
            <header class="flex justify-between items-center mb-10">
                <h1 class="text-3xl font-bold">–ù–æ–≤–∞—è —Å—Ç–∞—Ç—å—è</h1>
                <div class="flex gap-3">
                    <button onclick="openJsonModal()" class="flex items-center gap-2 px-4 py-3 bg-stone-800 text-white rounded hover:bg-stone-700 transition">
                        <span>üì•</span> –ò–º–ø–æ—Ä—Ç JSON
                    </button>
                </div>
            </header>

            <!-- JSON Modal -->
            <div id="json-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50">
                <div class="bg-white p-6 rounded-lg shadow-xl w-[600px] max-w-full">
                    <h3 class="text-xl font-bold mb-4">–í—Å—Ç–∞–≤—å—Ç–µ JSON</h3>
                    <p class="text-xs text-stone-500 mb-2">–§–æ—Ä–º–∞—Ç: { title, slug, category, summary, content, perspectives: [{type, title, content}] }</p>
                    <textarea id="json-input" rows="10" class="w-full p-3 border border-stone-300 rounded font-mono text-xs mb-4" placeholder='{"title": "..."}'></textarea>
                    <div class="flex justify-end gap-3">
                        <button onclick="closeJsonModal()" class="px-4 py-2 text-stone-600 hover:bg-stone-100 rounded">–û—Ç–º–µ–Ω–∞</button>
                        <button onclick="applyJson()" class="px-4 py-2 bg-green-700 text-white rounded hover:bg-green-800">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                    </div>
                </div>
            </div>

            <form id="article-form" class="space-y-8 bg-white p-8 rounded-xl shadow-sm border border-stone-200">
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold mb-2 text-stone-600">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
                        <input type="text" id="title" class="w-full p-3 border border-stone-200 rounded bg-stone-50 focus:bg-white transition" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–∞–¥–µ–Ω–∏–µ –†–∏–º–∞">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2 text-stone-600">Slug (URL)</label>
                        <input type="text" id="slug" class="w-full p-3 border border-stone-200 rounded bg-stone-50 font-mono text-sm" placeholder="fall-of-rome">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2 text-stone-600">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                    <select id="category" class="w-full p-3 border border-stone-200 rounded bg-stone-50">
                        <option>–ê–Ω—Ç–∏—á–Ω–æ—Å—Ç—å</option>
                        <option>–°—Ä–µ–¥–Ω–µ–≤–µ–∫–æ–≤—å–µ</option>
                        <option>–ù–æ–≤–æ–µ –≤—Ä–µ–º—è</option>
                        <option>XX –í–µ–∫</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2 text-stone-600">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏)</label>
                    <textarea id="summary" rows="3" class="w-full p-3 border border-stone-200 rounded bg-stone-50"></textarea>
                </div>

                <!-- Perspectives Block (The "Unitage" Feature) -->
                <div class="border-t border-stone-100 pt-6">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <span class="bg-stone-200 text-stone-700 px-2 rounded text-sm">–ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã</span>
                    </h3>
                    
                    <div class="bg-stone-50 p-6 rounded-lg border border-stone-200 mb-4">
                        <div class="flex justify-between mb-2">
                            <label class="text-xs font-bold uppercase text-stone-500">–û—Å–Ω–æ–≤–Ω–æ–π –Ω–∞—Ä—Ä–∞—Ç–∏–≤</label>
                        </div>
                        <textarea id="content" rows="10" class="w-full p-4 border border-stone-200 rounded text-sm font-mono" placeholder="# –í–≤–µ–¥–µ–Ω–∏–µ..."></textarea>
                    </div>

                    <div id="perspectives-container">
                        <!-- AI generated perspectives will appear here -->
                    </div>
                    
                    <button type="button" onclick="addPerspective()" class="text-sm text-red-800 font-medium hover:underline">+ –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—É –≤—Ä—É—á–Ω—É—é</button>
                </div>

                <div class="flex justify-end pt-6 gap-4">
                    <div class="text-xs text-stone-500 text-right max-w-xs">
                        * –í —Ä–µ–∂–∏–º–µ "–°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π JSON" –¥–∞–Ω–Ω—ã–µ –Ω–µ–ª—å–∑—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞–ø—Ä—è–º—É—é.
                        –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ JSON –∏ –¥–æ–±–∞–≤—å—Ç–µ –µ–≥–æ –≤ —Ñ–∞–π–ª <code>src/articles.json</code> –≤—Ä—É—á–Ω—É—é.
                    </div>
                    <button type="button" onclick="copyJSON()" class="px-8 py-3 bg-green-700 text-white font-bold rounded hover:bg-green-800 transition">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å JSON</button>
                </div>
            </form>
        </main>
    </div>

    <script>
        function copyJSON() {
             const formData = {
                id: Date.now(), // Fake ID
                title: document.getElementById('title').value,
                slug: document.getElementById('slug').value,
                category: document.getElementById('category').value,
                published_at: new Date().toISOString(),
                summary: document.getElementById('summary').value,
                content: document.getElementById('content').value,
                perspectives: []
            };

            // Collect perspectives
            const container = document.getElementById('perspectives-container');
            container.childNodes.forEach(node => {
                if(node.tagName === 'DIV') {
                    const inputs = node.querySelectorAll('input');
                    const textarea = node.querySelector('textarea');
                    formData.perspectives.push({
                        type: inputs[0].value,
                        title: inputs[1].value,
                        content: textarea.value
                    });
                }
            });

            const jsonString = JSON.stringify(formData, null, 2);
            navigator.clipboard.writeText(jsonString).then(() => {
                alert('JSON —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!\n–í—Å—Ç–∞–≤—å—Ç–µ –µ–≥–æ –≤ –º–∞—Å—Å–∏–≤ –≤ —Ñ–∞–π–ª–µ src/articles.json');
            });
        }

        function login() {
            const pass = document.getElementById('password').value;
            if (pass === 'admin123') { // Hardcoded for MVP demo
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
            } else {
                alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
            }
        }

        // JSON Modal Logic
        function openJsonModal() { document.getElementById('json-modal').classList.remove('hidden'); }
        function closeJsonModal() { document.getElementById('json-modal').classList.add('hidden'); }
        
        function applyJson() {
            try {
                const raw = document.getElementById('json-input').value;
                const data = JSON.parse(raw);
                
                // Fill basic fields
                if(data.title) document.getElementById('title').value = data.title;
                if(data.slug) document.getElementById('slug').value = data.slug;
                if(data.category) document.getElementById('category').value = data.category;
                if(data.summary) document.getElementById('summary').value = data.summary;
                if(data.content) document.getElementById('content').value = data.content;

                // Clear and Fill Perspectives
                if(data.perspectives && Array.isArray(data.perspectives)) {
                    const container = document.getElementById('perspectives-container');
                    container.innerHTML = ''; // Clear existing
                    
                    data.perspectives.forEach(p => {
                        addPerspective(); // Add DOM element
                        // Get the last added block
                        const block = container.lastElementChild;
                        const inputs = block.querySelectorAll('input');
                        const textarea = block.querySelector('textarea');
                        
                        inputs[0].value = p.type || 'context';
                        inputs[1].value = p.title || '';
                        textarea.value = p.content || '';
                    });
                }

                closeJsonModal();
                alert('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!');
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è JSON: ' + e.message);
            }
        }

        function addPerspective() {
            const container = document.getElementById('perspectives-container');
            const div = document.createElement('div');
            div.className = 'bg-stone-50 p-6 rounded-lg border border-stone-200 mb-4 relative';
            div.innerHTML = `
                <div class="grid grid-cols-2 gap-4 mb-3">
                    <input type="text" placeholder="–¢–∏–ø (–Ω–∞–ø—Ä. –≠–∫–æ–Ω–æ–º–∏–∫–∞)" class="p-2 border rounded text-sm">
                    <input type="text" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –±–ª–æ–∫–∞" class="p-2 border rounded text-sm">
                </div>
                <textarea rows="5" class="w-full p-3 border border-stone-200 rounded text-sm" placeholder="–¢–µ–∫—Å—Ç –∞–Ω–∞–ª–∏–∑–∞..."></textarea>
                <button onclick="this.parentElement.remove()" class="absolute top-2 right-2 text-stone-400 hover:text-red-600">&times;</button>
            `;
            container.appendChild(div);
        }

        async function generateAnalysis() {
            const topic = document.getElementById('title').value;
            if (!topic) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–µ–º—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞');
                return;
            }

            const btn = document.querySelector('button[onclick="generateAnalysis()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span>‚è≥</span> –î—É–º–∞—é...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/admin/generate-analysis', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ topic })
                });
                const data = await response.json();
                
                alert(data.preview + '\\n\\n–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–µ —É–≥–ª—ã –æ–±–∑–æ—Ä–∞:\\n' + data.suggested_perspectives.join('\\n'));
                
                // Simulation of populating fields
                document.getElementById('summary').value = `–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —Ç–µ–º—ã "${topic}"...`;
                
                // Simulate AI agents working
                addPerspective();
                const pInputs = document.getElementById('perspectives-container').lastElementChild.querySelectorAll('input');
                pInputs[0].value = "–≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–π –≤–∑–≥–ª—è–¥";
                pInputs[1].value = "–¶–µ–Ω–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞";
                
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ AI: ' + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        document.getElementById('article-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            // Here we would gather all data and send to /api/admin/articles
            const formData = {
                title: document.getElementById('title').value,
                slug: document.getElementById('slug').value,
                category: document.getElementById('category').value,
                summary: document.getElementById('summary').value,
                content: document.getElementById('content').value
            };

            try {
                const res = await fetch('/api/admin/articles', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(formData)
                });
                const result = await res.json();
                if (result.success) {
                    alert('–°—Ç–∞—Ç—å—è —Å–æ–∑–¥–∞–Ω–∞! ID: ' + result.id);
                } else {
                    alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è');
                }
            } catch (err) {
                console.error(err);
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        });
    </script>
</body>
</html>
